<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width">

        <title>پکیج IPay : نسخه 1</title>
        <meta name="description" content="مستندات پکیج IPay">

        <link href="/css/bootstrap-combined.no-icons.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/css/syntax.css">
        <link rel="stylesheet" href="/css/main.css">
    </head>
    <body class="rtl">

        <div class="container">
            <div class=row-fluid>
                <div id=header class=span12>
                    <h4><a class=brand href="/">پکیج IPay</a>
    <small>مستندات پکیج IPay</small>
</h4>

                </div>
            </div>

            <div class=row-fluid>
                
                
                    <div id=navigation class=span2>
                        <ul class="nav nav-list">
    <li><a href="/">صفحه نخست</a></li>
    
        
        

        
            
                <li class=nav-header>مستندات</li>
            
            <li data-order=""><a href="/doc/version-1.html">نسخه 1</a></li>
        
    
        
        

        
            
                <li class=nav-header>قسمت های دیگر</li>
            
            <li data-order=""><a href="/others/changelog.html">تغییرات پکیج</a></li>
        
    
        
        

        
    
        
        

        
    
        
        

        
    
<!-- List additional links. It is recommended to add a divider
    e.g. <li class=divider></li> first to break up the content. -->
</ul>

                    </div>

                    <div id=content class=span10>
                        <div class=page-header>
    <h2>نسخه 1
        <small>مستندات نسخه 1</small>
    </h2>
</div>

<ul>
<li><a href="#database">ایجاد جدول پکیج درون دیتابیس</a></li>
<li><a href="#mellat">مستندات مخصوص درگاه بانک ملت</a></li>
<li><a href="#zarinpal">مستندات مخصوص درگاه زرین پال</a></li>
</ul>

<p><a name="databse"></a></p>

<h3 id="ایجاد-جدول-پکیج-درون-دیتابیس">ایجاد جدول پکیج درون دیتابیس</h3>

<p>این نسخه پکیج، از دیتابیس، برای ذخیره لاگ ها و مدیریت اتصال به بانک استفاده میکند. برای اینکار باید جدولی به نام <code>mellat_orders_log</code> بسازید که کد SQL آن در زیر آمده است.</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">mellat_orders_log</span><span class="o">`</span> <span class="p">(</span>
<span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
<span class="o">`</span><span class="n">ref_id</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">COLLATE</span> <span class="n">utf8_unicode_ci</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="o">`</span><span class="n">sale_order_id</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">COLLATE</span> <span class="n">utf8_unicode_ci</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="o">`</span><span class="n">sale_refrences_id</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">COLLATE</span> <span class="n">utf8_unicode_ci</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="o">`</span><span class="n">additional_data</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span> <span class="k">COLLATE</span> <span class="n">utf8_unicode_ci</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="o">`</span><span class="n">message</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">250</span><span class="p">)</span> <span class="k">COLLATE</span> <span class="n">utf8_unicode_ci</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="o">`</span><span class="k">timestamp</span><span class="o">`</span> <span class="n">datetime</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span> <span class="k">COLLATE</span><span class="o">=</span><span class="n">utf8_unicode_ci</span> <span class="n">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">22</span> <span class="p">;</span>
</code></pre></div>
<p><a name="mellat"></a></p>

<h3 id="مستندات-مخصوص-درگاه-بانک-ملت">مستندات مخصوص درگاه بانک ملت</h3>

<p>متدهای زیر به صورت قدم به قدم برای اتصال به بانک و تایید پرداخت کاربر توضیح داده میشود. متدهای کمکی دیگر در انتها توضیح داده میشود.</p>

<h4 id="قدم-اول:-منتقل-کردن-کاربر-به-درگاه">قدم اول: منتقل کردن کاربر به درگاه</h4>

<ol>
<li>ساختن شیء از کلاس</li>
</ol>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">use IPay\Mellat\IPayMellat;</span>
<span class="x">.</span>
<span class="x">.</span>
<span class="x">.</span>
<span class="x">$mellatPay = new IPayMellat($username, $password, $termId);</span>
</code></pre></div>
<p>در هنگام ساختن یک شیء جدید از کلاس IPayMellat باید نام کاربری، رمز عبور و شماره پایانه ای که بانک به شما داده است را به کلاس بدهید.</p>

<ol>
<li>ست کردن تنظیمات دیتابیس</li>
</ol>

<p>حالا برای ست کردن تنظیمات دیتابیس در شیء ساخته شده، به صورت زیر کار میکنیم.</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">$mellatPay-&gt;setDB($server, $dbName, $username, $password);</span>
</code></pre></div>
<ol>
<li>ارسال درخواست اتصال به درگاه بانک ملت</li>
</ol>

<p>با استفاده از متد <code>sendPayRequest</code> میتوانید درخواست اتصال به سرور بانک را بدهید. این متد دارای دو پارامتر است. پارامتر اول مبلغی است که میخواهید کاربر واریز کند و پارامتر دوم آدرسی است که میخواهید درگاه، کاربر را  پس از انجام عملیات به آن آدرس بازگشت بدهد.</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">$mellatPay-&gt;sendPayRequest($price, $callbackUrl);</span>
</code></pre></div>
<ol>
<li>ریدایرکت کاربر به درگاه</li>
</ol>

<p>برای ریدایرکت کاربر به درگاه، ابتدا توسط متد <code>passPayRequest</code> چک میکنیم که آیا بانک آماده برای منتقل کردن کاربر است و هیچ مشکلی پیش نیامده است که در این صورت کاربر را به درگاه منتقل میکنیم. اگر هم خطایی پیش آمد با استفاده از متد <code>getPayRequestResCode</code> میتوانیم شماره خطا را دریافت کنیم. همچنین توسط متد <code>getRefId</code> میتوانیم شماره <code>refId</code> را ذخیره کنیم تا پس از بازگشت کاربر به سایت بتوانیم مشخص کنیم که کدام کاربر و برای کدام محصول پرداخت را انجام داده است.</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">if ($mellatPay-&gt;passPayRequest())</span>
<span class="x">{</span>
<span class="x">  $productRefId = $mellatPay-&gt;getRefId();</span>
<span class="x">    .</span>
<span class="x">    .</span>
<span class="x">    .</span>
<span class="x">  $mellatPay-&gt;redirectToBank();</span>
<span class="x">}</span>
<span class="x">else</span>
<span class="x">{</span>
<span class="x">  //Error</span>
<span class="x">  $errorNumber = $mellatPay-&gt;getPayRequestResCode();</span>
<span class="x">}</span>
</code></pre></div>
<h4 id="قدم-دوم:-گرفتن-جواب-از-درگاه-بانک-ملت">قدم دوم: گرفتن جواب از درگاه بانک ملت</h4>

<p>پس از اتمام عملیات کاربر در درگاه بانک، کاربر به آدرسی که ما در قدم اول مشخص کردیم منتقل میشود. حالا در این آدرس ما باید چک کنیم که آیا کاربر پرداخت را انجام داده است یا خیر؟</p>

<ol>
<li>ساخت شیء و ست کردن تنظیمات دیتابیس</li>
</ol>

<p>در ابتدا باید دو مرحله اول قدم اول را نیز در اینجا تکرار کنیم.</p>

<ol>
<li>چک کردن اینکه کاربر آیا پرداخت را انجام داده است یا خیر؟</li>
</ol>

<p>در کد زیر توسط سه متد <code>userPayment</code>, <code>verifyPayment</code> و <code>settleRequest</code> چک میکنیم که آیا کاربر پرداخت را انجام داده است یا خیر؟ متد <code>userPayment</code> توسط داده های بازگشتی از بانک چک میکند که آیا پرداخت انجام شده است یا خیر؟ متد <code>verifyPayment</code> توسط بانک چک میکند که آیا کاربر پرداخت را انجام داده است یا خیر؟ و متد <code>settleRequest</code> درخواست واریز وجه به حساب از بانک را میکند. اگر هر سه این متدها جواب <code>true</code> برگردانند، به این معنی است که کاربر پرداخت را انجام داده است. در غیر این صورت خطای مناسب را به کاربر نمایش میدهیم.</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">if ($mellatPay-&gt;userPayment() &amp;&amp; $mellatPay-&gt;verifyPayment())</span>
<span class="x">{</span>
<span class="x">    if ($mellatPay-&gt;settleRequest())</span>
<span class="x">    {</span>
<span class="x">      $productRefId = $mellatPay-&gt;getRefId()</span>
<span class="x">        .</span>
<span class="x">        .</span>
<span class="x">        .</span>
<span class="x">    }</span>
<span class="x">    else</span>
<span class="x">    {</span>
<span class="x">      return &#39;error&#39;;</span>
<span class="x">    }</span>
<span class="x">}</span>
<span class="x">else</span>
<span class="x">{</span>
<span class="x">    return &#39;error&#39;;</span>
<span class="x">}</span>
</code></pre></div>
<p>وسط دو قدم گفته شده در بالا میتوانید کل روند پرداخت بانک ملت را انجام دهید.</p>

<h4 id="متدهای-کمکی">متدهای کمکی</h4>

<h5 id="متد-setdebugmode">متد setDebugMode</h5>

<p>توسط این متد میتوانید مشخص کنید که آیا در حالت تست درگاه قرار دارید یا خیر؟ این متد فقط میتواند در قدم اول و بعد از دو مرحله اول صدا زده شود تا کارایی خود را نشان دهد. اگر این متد صدا زده بشود، اگر درگاه به هر خطایی در ارتباط با بانک برخورد کند یک <code>Exception</code> برمیگرداند و شماره خطا و متن خطا بر اساس مستندات بانک ملت را به شما نشان میدهد که در زمان توسعه درگاه میتواند کمک بزرگی به شما باشد. پارامتر اول این تابع میتواند مقدار <code>‘en’</code><code>یا</code><code>‘fa’</code>` را بگیرد. که زبان متن خطا را مشخص میکند.</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">$mellatPay = new IPayMellat(&#39;site56&#39;, 69202546, 6541369);</span>
<span class="x">$mellatPay-&gt;setDB(&#39;localhost&#39;, &#39;my_db&#39;, &#39;root&#39;, &#39;5d5sa6d&#39;);</span>
<span class="x">$mellatPay-&gt;setDebugMode(&#39;fa&#39;);</span>
</code></pre></div>
<p><a name="zarinpal"></a></p>

<h3 id="مستندات-مخصوص-درگاه-زرین-پال">مستندات مخصوص درگاه زرین پال</h3>

<h4 id="قدم-اول:-منتقل-کردن-کاربر-به-درگاه">قدم اول: منتقل کردن کاربر به درگاه</h4>

<ol>
<li>ساختن شیء از کلاس</li>
</ol>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">use IPay\Zarinpal\IPayZarinpal;</span>
<span class="x">.</span>
<span class="x">.</span>
<span class="x">.</span>
<span class="x">$zarinPay = new IPayZarinpal($merchentId);</span>
</code></pre></div>
<p>در هنگام ساختن یک شیء جدید از کلاس IPayZarinpal باید مرچنت کد را که زرین پال به شما داده است را به کلاس بدهید.</p>

<ol>
<li>ست کردن تنظیمات دیتابیس</li>
</ol>

<p>حالا برای ست کردن تنظیمات دیتابیس در شیء ساخته شده، به صورت زیر کار میکنیم.</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">$zarinPay-&gt;setDB($server, $dbName, $username, $password);</span>
</code></pre></div>
<ol>
<li>ارسال درخواست اتصال به درگاه زرین پال</li>
</ol>

<p>با استفاده از متد <code>sendPayRequest</code> میتوانید درخواست اتصال به زرین پال را بدهید. این متد دارای سه پارامتر است. پارامتر اول مبلغی است که میخواهید کاربر واریز کند (به تومان) و پارامتر دوم آدرسی است که میخواهید درگاه، کاربر را  پس از انجام عملیات به آن آدرس بازگشت بدهد و در پارامتر سوم آرایه ای از اطلاعات مختلفی مانند آدرس ایمیل، شماره موبایل و توضیحات را میگیرد.</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">$additionalData = array(</span>
<span class="x">    &#39;email&#39; =&gt; &#39;email@gmail.com&#39;,</span>
<span class="x">    &#39;mobile&#39; =&gt; &#39;09xxxxxxxxx&#39;,</span>
<span class="x">    &#39;description&#39; =&gt; &#39;description&#39;</span>
<span class="x">);</span>
<span class="x">$zarinPay-&gt;sendPayRequest(4000, $callbackUrl, $additionalData);</span>
</code></pre></div>
<ol>
<li>ریدایرکت کاربر به درگاه</li>
</ol>

<p>برای ریدایرکت کاربر به درگاه، ابتدا توسط متد <code>passPayRequest</code> چک میکنیم که آیا زرین پال آماده برای منتقل کردن کاربر است و هیچ مشکلی پیش نیامده است که در این صورت کاربر را به درگاه منتقل میکنیم. اگر هم خطایی پیش آمد با استفاده از متد getStatusCode میتوانیم شماره خطا را دریافت کنیم. همچنین توسط متد <code>getAuthority</code> میتوانیم شماره <code>authority</code> را ذخیره کنیم تا پس از بازگشت کاربر به سایت بتوانیم مشخص کنیم که کدام کاربر و برای کدام محصول پرداخت را انجام داده است.</p>

<p><code>authority</code> کدی یکتا است که زرین پال برای هر درخواست به درگاه، اختصاص میدهد.</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">if ($zarinPay-&gt;passPayRequest())</span>
<span class="x">{</span>
<span class="x">    $productAuthority = $zarinPay-&gt;getAuthority();</span>
<span class="x">      .</span>
<span class="x">      .</span>
<span class="x">      .</span>
<span class="x">    return $zarinPay-&gt;redirectToBank();</span>
<span class="x">}</span>
<span class="x">else</span>
<span class="x">{</span>
<span class="x">    //Error</span>
<span class="x">    $errorNumber = $zarinPay-&gt;getStatusCode();</span>
<span class="x">}</span>
</code></pre></div>
<h4 id="قدم-دوم:-گرفتن-جواب-از-درگاه-زرین-پال">قدم دوم: گرفتن جواب از درگاه زرین پال</h4>

<p>پس از اتمام عملیات کاربر در درگاه، کاربر به آدرسی که ما در قدم اول مشخص کردیم منتقل میشود. حالا در این آدرس ما باید چک کنیم که آیا کاربر پرداخت را انجام داده است یا خیر؟</p>

<ol>
<li>ساخت شیء و ست کردن تنظیمات دیتابیس</li>
</ol>

<p>در ابتدا باید دو مرحله اول قدم اول را نیز در اینجا تکرار کنیم.</p>

<ol>
<li>چک کردن اینکه کاربر آیا پرداخت را انجام داده است یا خیر؟</li>
</ol>

<p>در کد زیر توسط دو متد <code>userPayment</code>, <code>verifyPayment</code> چک میکنیم که آیا کاربر پرداخت را انجام داده است یا خیر؟ متد <code>userPayment</code> توسط داده های بازگشتی از بانک چک میکند که آیا پرداخت انجام شده است یا خیر؟ متد <code>verifyPayment</code> توسط سرور زرین پال چک میکند که آیا کاربر پرداخت را انجام داده است یا خیر؟  اگر هر دو این متدها جواب <code>true</code> برگردانند، به این معنی است که کاربر پرداخت را انجام داده است. در غیر این صورت خطای مناسب را به کاربر نمایش میدهیم.</p>

<p>در این مرحله اگر پرداخت به درستی انجام شده باشد زرین پال کدی را تحت عنوان <code>refId</code> میدهد که برای پیگیری پرداخت به کار میرود. این کد را از طریق متد <code>getRefId</code> میتوان گرفت.</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">if ($zarinPay-&gt;userPayment() &amp;&amp; $zarinPay-&gt;verifyPayment())</span>
<span class="x">{</span>
<span class="x">    $productAuthority = $zarinPay-&gt;getAuthority();</span>
<span class="x">    $refId = $zarinPay-&gt;getRefId();</span>
<span class="x">      .</span>
<span class="x">      .</span>
<span class="x">      .</span>
<span class="x">}</span>
<span class="x">else</span>
<span class="x">{</span>
<span class="x">    //Error</span>
<span class="x">    $errorNumber = $zarinPay-&gt;getStatusCode();</span>
<span class="x">}</span>
</code></pre></div>
<p>توسط دو قدم گفته شده در بالا میتوانید کل روند پرداخت درگاه زرین پال را انجام دهید.</p>

<h4 id="متدهای-کمکی">متدهای کمکی</h4>

<h4 id="متد-setdebugmode">متد setDebugMode</h4>

<p>توسط این متد میتوانید مشخص کنید که آیا در حالت تست درگاه قرار دارید یا خیر؟ این متد فقط میتواند در قدم اول و بعد از دو مرحله اول صدا زده شود تا کارایی خود را نشان دهد. اگر این متد صدا زده بشود، اگر درگاه به هر خطایی در ارتباط با درگاه برخورد کند یک Exception برمیگرداند و شماره خطا و متن خطا بر اساس مستندات زرین پال را به شما نشان میدهد که در زمان توسعه درگاه میتواند کمک بزرگی به شما باشد. پارامتر اول این تابع میتواند مقدار ‘en’ یا ‘fa’ را بگیرد. که زبان متن خطا را مشخص میکند.</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">$zarinPay = new IPayZarinpal(&#39;xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxxx);</span>
<span class="x">$zarinPay-&gt;setDB(&#39;localhost&#39;, &#39;my_db&#39;, &#39;root&#39;, &#39;5d5sa6d&#39;);</span>
<span class="x">$zarinPay-&gt;setDebugMode(&#39;fa&#39;);</span>
</code></pre></div>

                    </div>
                
            </div>

            

            <div class=row-fluid>
                <div id=footer class=span12>
                    مستندات برای <a href="http://github.com/mohsen-shafiee/ipay">پکیج IPay</a>

<div class="social text-center">
    <a href="http://github.com/mohsen-shafiee/ipay">Github</a> |
    <a href="http://packagist.org/packages/mohsen/ipay">Packagist</a>
</div>

                </div>
            </div>
        </div>

        <script>
            function orderNav() {
                var list,
                    section,
                    header,
                    sections = [],
                    lists = {},
                    headers = {};

                var navUl = document.querySelectorAll('#navigation ul')[0],
                    navLis = document.querySelectorAll('#navigation ul li');

                if (!navUl) return;

                for (var i = 0; i < navLis.length; i++) {
                    var order, li = navLis[i];

                    if (li.classList.contains('nav-header')) {
                        section = li.textContent || li.innerText;
                        sections.push(section);
                        headers[section] = li;
                        continue;
                    }

                    if (!lists[section]) {
                        lists[section] = [];
                    }

                    order = parseFloat(li.getAttribute('data-order'))
                    lists[section].push([order, li]);
                }

                for (var i = 0; i < sections.length; i++) {
                    section = sections[i];
                    list = lists[section].sort(function(a, b) {
                        return a[0] - b[0];
                    });

                    if (header = headers[section]) {
                        navUl.appendChild(header);
                    }
                    for (var j = 0; j < list.length; j++) {
                        navUl.appendChild(list[j][1]);
                    }
                }
            }

            if (document.querySelectorAll) orderNav();
        </script>
        
    </body>
</html>
