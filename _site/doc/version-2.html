<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width">

        <title>پکیج IPay : نسخه 2</title>
        <meta name="description" content="مستندات پکیج IPay">

        <link href="/ipay/css/bootstrap-combined.no-icons.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/ipay/css/syntax.css">
        <link rel="stylesheet" href="/ipay/css/main.css">
    </head>
    <body class="rtl">

        <div class="container">
            <div class=row-fluid>
                <div id=header class=span12>
                    <h4><a class=brand href="/ipay/">پکیج IPay</a>
    <small>مستندات پکیج IPay</small>
</h4>

                </div>
            </div>

            <div class=row-fluid>
                
                
                    <div id=navigation class=span2>
                        <ul class="nav nav-list">
    <li><a href="/ipay/">صفحه نخست</a></li>
    
        
        

        
            
                <li class=nav-header>مستندات</li>
            
            <li data-order=""><a href="/ipay/doc/version-2.html">نسخه 2</a></li>
        
            
            <li data-order=""><a href="/ipay/doc/version-1.html">نسخه 1</a></li>
        
    
        
        

        
            
                <li class=nav-header>قسمت های دیگر</li>
            
            <li data-order=""><a href="/ipay/others/changelog.html">تغییرات پکیج</a></li>
        
    
        
        

        
    
        
        

        
    
        
        

        
    
<!-- List additional links. It is recommended to add a divider
    e.g. <li class=divider></li> first to break up the content. -->
</ul>

                    </div>

                    <div id=content class=span10>
                        <div class=page-header>
    <h2>نسخه 2
        <small>مستندات نسخه 2</small>
    </h2>
</div>

<ul>
<li><a href="#config">فایل تنظیمات پکیج</a></li>
<li><a href="#mellat">مستندات مخصوص درگاه بانک ملت</a></li>
<li><a href="#zarinpal">مستندات مخصوص درگاه زرین پال</a></li>
</ul>

<p><a name="config"></a></p>

<h3 id="فایل-تنظیمات-پکیج">فایل تنظیمات پکیج</h3>

<p>از نسخه 2 به بعد فایلی به عنوان تنظیمات پکیج IPay وجود دارد. وجود این فایل باعث بهبود بسیار خوبی در استفاده راحتتر از پکیج شده است.</p>

<p>در این فایل شما میتوانید تمام اطلاعات و تنظیمات مورد نیاز برای پکیج را وارد کنید. مسیر پیشفرض فایل در کنار پوشه <code>vendor</code> و با نام <code>ipay.php</code> است، اما شما میتوانید این فایل را در هر مسیری که میخواهید قرار بدهید و آدرس را در هنگام ساخت شی از کلاس به IPay بدهید.</p>

<p>این فایل در نسخه 2 دارای تنظیمات زیر است. شما باید فایل <code>ipay.php</code> را همراه با محتویات زیر در کنار پوشه <code>vendor</code> (یا هر مسیری که میخواهید)ایجاد کنید.</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">return</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;database&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;host&#39;</span>     <span class="o">=&gt;</span> <span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dbname&#39;</span>   <span class="o">=&gt;</span> <span class="s1">&#39;database_name&#39;</span><span class="p">,</span>
        <span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span>
        <span class="s1">&#39;password&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;xxxxxx&#39;</span><span class="p">,</span>
        <span class="s1">&#39;create&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span>
    <span class="p">),</span>

    <span class="s1">&#39;debug&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;status&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
        <span class="s1">&#39;lang&#39;</span>   <span class="o">=&gt;</span> <span class="s1">&#39;fa&#39;</span>
    <span class="p">),</span>

    <span class="s1">&#39;zarinpal&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;merchant-id&#39;</span>  <span class="o">=&gt;</span> <span class="s1">&#39;xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&#39;</span><span class="p">,</span>
        <span class="s1">&#39;callback-url&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;url&#39;</span><span class="p">,</span>
        <span class="s1">&#39;server&#39;</span>       <span class="o">=&gt;</span> <span class="s1">&#39;germany&#39;</span><span class="p">,</span>
        <span class="s1">&#39;email&#39;</span>        <span class="o">=&gt;</span> <span class="s1">&#39;email@gmail.com&#39;</span><span class="p">,</span>
        <span class="s1">&#39;mobile&#39;</span>       <span class="o">=&gt;</span> <span class="s1">&#39;09xxxxxxxxx&#39;</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span>  <span class="o">=&gt;</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span>
    <span class="p">),</span>

    <span class="s1">&#39;mellat&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;username&#39;</span>     <span class="o">=&gt;</span> <span class="s1">&#39;username&#39;</span><span class="p">,</span>
        <span class="s1">&#39;password&#39;</span>     <span class="o">=&gt;</span> <span class="mo">00000000</span><span class="p">,</span>
        <span class="s1">&#39;terminalId&#39;</span>   <span class="o">=&gt;</span> <span class="mo">0000000</span><span class="p">,</span>
        <span class="s1">&#39;callback-url&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;url&#39;</span>
    <span class="p">)</span>
<span class="p">);</span>
</code></pre></div>
<p>تنظیمات <code>database</code> برای اتصال به پایگاه داده است. در صورتی که قسمت <code>create</code> فعال (<code>true</code>) باشد، در هر بار استفاده از IPay، پکیج چک میکند که آیا جداول پکیج ایجاد شده است یا خیر، در صورتی که موجود نبودند، خود پکیج به صورت خودکار آنها را نصب میکند. پس توجه داشته باشید که در اولین استفاده از پکیج این گزینه را <code>true</code> کنید.</p>

<p>تنظیمات <code>debug</code> برای فعال سازی محیط تست پکیج است.</p>

<p>تنظیمات <code>zarinpal</code> و <code>mellat</code> برای درگاه های بانک ملت و سایت زرین پال است. توجه داشته باشید که در صورت استفاده از هر کدام از درگاه ها ابتدا تنظیمات آن را به درستی پر کرده باشید.
<a name="mellat"></a></p>

<h3 id="مستندات-مخصوص-درگاه-بانک-ملت">مستندات مخصوص درگاه بانک ملت</h3>

<p>متدهای زیر به صورت قدم به قدم برای اتصال به بانک و تایید پرداخت کاربر توضیح داده میشود.</p>

<h4 id="قدم-اول:-منتقل-کردن-کاربر-به-درگاه">قدم اول: منتقل کردن کاربر به درگاه</h4>

<ol>
<li>ساختن شیء از کلاس</li>
</ol>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">use IPay\Mellat\IPayMellat;</span>
<span class="x">.</span>
<span class="x">.</span>
<span class="x">.</span>
<span class="x">$mellatPay = new IPayMellat();</span>
</code></pre></div>
<p>در صورتی که فایل تنظمیات پکیج را در مسیر پیشفرض (کنار پوشه <code>vendor</code> با نام <code>ipay.php</code>) قرار نداده اید و در مسیری دیگر وجود دارد، مسیر آن را به عنوان پارامتر اول به کلاس <code>IPayMellat</code> بدهید.</p>

<ol>
<li>ارسال درخواست اتصال به درگاه بانک ملت</li>
</ol>

<p>با استفاده از متد <code>sendPayRequest</code> میتوانید درخواست اتصال به سرور بانک را بدهید. این متد دارای سه پارامتر است که تنها پارامتر اول اجباری است.</p>

<p>پارامتر اول: مبلغی است که میخواهید کاربر واریز کند.</p>

<p>پارامتر دوم (اختیاری): اطلاعات اضافی. این اطلاعات اضافی به سرور بانک فرستاده میشود و بدون هیچ تغییر بازگشت داده میشود.</p>

<p>پارامتر سوم (اختیاری): آدرس بازگشتی. در صورتی که این پارامتر داده نشود، آدرس را از فایل تنظیمات میخواند.</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">$mellatPay-&gt;sendPayRequest($amount, $additionalData, $callBackUrl);</span>
</code></pre></div>
<ol>
<li>ریدایرکت کاربر به درگاه</li>
</ol>

<p>برای ریدایرکت کاربر به درگاه، ابتدا توسط متد <code>passPayRequest</code> چک میکنیم که آیا بانک آماده برای منتقل کردن کاربر است و هیچ مشکلی پیش نیامده است که در این صورت کاربر را به درگاه منتقل میکنیم. اگر هم خطایی پیش آمد با استفاده از متد <code>getPayRequestResCode</code> میتوانیم شماره خطا را دریافت کنیم. همچنین توسط متد <code>getRefId</code> میتوانیم شماره <code>refId</code> را ذخیره کنیم تا پس از بازگشت کاربر به سایت بتوانیم مشخص کنیم که کدام کاربر و برای کدام محصول پرداخت را انجام داده است.</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">if ($mellatPay-&gt;passPayRequest())</span>
<span class="x">{</span>
<span class="x">  $productRefId = $mellatPay-&gt;getRefId();</span>
<span class="x">    .</span>
<span class="x">    .</span>
<span class="x">    .</span>
<span class="x">  $mellatPay-&gt;redirectToBank();</span>
<span class="x">}</span>
<span class="x">else</span>
<span class="x">{</span>
<span class="x">  //Error</span>
<span class="x">  $errorNumber = $mellatPay-&gt;getPayRequestResCode();</span>
<span class="x">}</span>
</code></pre></div>
<h4 id="قدم-دوم:-گرفتن-جواب-از-درگاه-بانک-ملت">قدم دوم: گرفتن جواب از درگاه بانک ملت</h4>

<p>پس از اتمام عملیات کاربر در درگاه بانک، کاربر به آدرسی که ما در قدم اول مشخص کردیم منتقل میشود. حالا در این آدرس ما باید چک کنیم که آیا کاربر پرداخت را انجام داده است یا خیر؟</p>

<ol>
<li>ساخت شیء</li>
</ol>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">use IPay\Mellat\IPayMellat;</span>
<span class="x">.</span>
<span class="x">.</span>
<span class="x">.</span>
<span class="x">$mellatPay = new IPayMellat();</span>
</code></pre></div>
<ol>
<li>چک کردن اینکه کاربر آیا پرداخت را انجام داده است یا خیر؟</li>
</ol>

<p>در کد زیر توسط سه متد <code>userPayment</code>, <code>verifyPayment</code> و <code>settleRequest</code> چک میکنیم که آیا کاربر پرداخت را انجام داده است یا خیر؟ متد <code>userPayment</code> توسط داده های بازگشتی از بانک چک میکند که آیا پرداخت انجام شده است یا خیر؟ متد <code>verifyPayment</code> توسط بانک چک میکند که آیا کاربر پرداخت را انجام داده است یا خیر؟ و متد <code>settleRequest</code> درخواست واریز وجه به حساب از بانک را میکند. اگر هر سه این متدها جواب <code>true</code> برگردانند، به این معنی است که کاربر پرداخت را انجام داده است. در غیر این صورت خطای مناسب را به کاربر نمایش میدهیم.</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">if ($mellatPay-&gt;userPayment() &amp;&amp; $mellatPay-&gt;verifyPayment())</span>
<span class="x">{</span>
<span class="x">    if ($mellatPay-&gt;settleRequest())</span>
<span class="x">    {</span>
<span class="x">      $productRefId = $mellatPay-&gt;getRefId()</span>
<span class="x">        .</span>
<span class="x">        .</span>
<span class="x">        .</span>
<span class="x">    }</span>
<span class="x">    else</span>
<span class="x">    {</span>
<span class="x">      return &#39;error&#39;;</span>
<span class="x">    }</span>
<span class="x">}</span>
<span class="x">else</span>
<span class="x">{</span>
<span class="x">    return &#39;error&#39;;</span>
<span class="x">}</span>
</code></pre></div>
<p>توسط دو قدم گفته شده در بالا میتوانید کل روند پرداخت بانک ملت را انجام دهید.</p>

<p><a name="zarinpal"></a></p>

<h3 id="مستندات-مخصوص-درگاه-زرین-پال">مستندات مخصوص درگاه زرین پال</h3>

<h4 id="قدم-اول:-منتقل-کردن-کاربر-به-درگاه">قدم اول: منتقل کردن کاربر به درگاه</h4>

<ol>
<li>ساختن شیء از کلاس</li>
</ol>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">use IPay\Zarinpal\IPayZarinpal;</span>
<span class="x">.</span>
<span class="x">.</span>
<span class="x">.</span>
<span class="x">$zarinPay = new IPayZarinpal($merchentId);</span>
</code></pre></div>
<p>در صورتی که فایل تنظمیات پکیج را در مسیر پیشفرض (کنار پوشه <code>vendor</code> با نام <code>ipay.php</code>) قرار نداده اید و در مسیری دیگر وجود دارد، مسیر آن را به عنوان پارامتر اول به کلاس <code>IPayZarinpal</code> بدهید.</p>

<ol>
<li>ارسال درخواست اتصال به درگاه زرین پال</li>
</ol>

<p>با استفاده از متد <code>sendPayRequest</code> میتوانید درخواست اتصال به زرین پال را بدهید. این متد دارای دو پارامتر است که تنها پارامتر اول اجباری است.</p>

<p>پارامتر اول: مبلغی است که میخواهید کاربر واریز کند (به تومان).</p>

<p>پارامتر دوم (اختیاری): آدرس بازگشتی. در صورتی که این پارامتر داده نشود، آدرس را از فایل تنظیمات میخواند.</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">$zarinPay-&gt;sendPayRequest(4000, $callbackUrl);</span>
</code></pre></div>
<ol>
<li>ریدایرکت کاربر به درگاه</li>
</ol>

<p>برای ریدایرکت کاربر به درگاه، ابتدا توسط متد <code>passPayRequest</code> چک میکنیم که آیا زرین پال آماده برای منتقل کردن کاربر است و هیچ مشکلی پیش نیامده است که در این صورت کاربر را به درگاه منتقل میکنیم. اگر هم خطایی پیش آمد با استفاده از متد getStatusCode میتوانیم شماره خطا را دریافت کنیم. همچنین توسط متد <code>getAuthority</code> میتوانیم شماره <code>authority</code> را ذخیره کنیم تا پس از بازگشت کاربر به سایت بتوانیم مشخص کنیم که کدام کاربر و برای کدام محصول پرداخت را انجام داده است.</p>

<p><code>authority</code> کدی یکتا است که زرین پال برای هر درخواست به درگاه، اختصاص میدهد.</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">if ($zarinPay-&gt;passPayRequest())</span>
<span class="x">{</span>
<span class="x">    $productAuthority = $zarinPay-&gt;getAuthority();</span>
<span class="x">      .</span>
<span class="x">      .</span>
<span class="x">      .</span>
<span class="x">    return $zarinPay-&gt;redirectToBank();</span>
<span class="x">}</span>
<span class="x">else</span>
<span class="x">{</span>
<span class="x">    //Error</span>
<span class="x">    $errorNumber = $zarinPay-&gt;getStatusCode();</span>
<span class="x">}</span>
</code></pre></div>
<p>در صورتی که میخواهید به زرین گیت ریدایرکت کنید پارامتر اول متد <code>redirectToBank</code> را <code>true</code> قرار دهید.</p>

<h4 id="قدم-دوم:-گرفتن-جواب-از-درگاه-زرین-پال">قدم دوم: گرفتن جواب از درگاه زرین پال</h4>

<p>پس از اتمام عملیات کاربر در درگاه، کاربر به آدرسی که ما در قدم اول مشخص کردیم منتقل میشود. حالا در این آدرس ما باید چک کنیم که آیا کاربر پرداخت را انجام داده است یا خیر؟</p>

<ol>
<li>ساخت شیء از کلاس</li>
</ol>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">use IPay\Zarinpal\IPayZarinpal;</span>
<span class="x">.</span>
<span class="x">.</span>
<span class="x">.</span>
<span class="x">$zarinPay = new IPayZarinpal($merchentId);</span>
</code></pre></div>
<ol>
<li>چک کردن اینکه کاربر آیا پرداخت را انجام داده است یا خیر؟</li>
</ol>

<p>در کد زیر توسط دو متد <code>userPayment</code>, <code>verifyPayment</code> چک میکنیم که آیا کاربر پرداخت را انجام داده است یا خیر؟ متد <code>userPayment</code> توسط داده های بازگشتی از بانک چک میکند که آیا پرداخت انجام شده است یا خیر؟ متد <code>verifyPayment</code> توسط سرور زرین پال چک میکند که آیا کاربر پرداخت را انجام داده است یا خیر؟  اگر هر دو این متدها جواب <code>true</code> برگردانند، به این معنی است که کاربر پرداخت را انجام داده است. در غیر این صورت خطای مناسب را به کاربر نمایش میدهیم.</p>

<p>در این مرحله اگر پرداخت به درستی انجام شده باشد زرین پال کدی را تحت عنوان <code>refId</code> میدهد که برای پیگیری پرداخت به کار میرود. این کد را از طریق متد <code>getRefId</code> میتوان گرفت.</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">if ($zarinPay-&gt;userPayment() &amp;&amp; $zarinPay-&gt;verifyPayment())</span>
<span class="x">{</span>
<span class="x">    $productAuthority = $zarinPay-&gt;getAuthority();</span>
<span class="x">    $refId = $zarinPay-&gt;getRefId();</span>
<span class="x">      .</span>
<span class="x">      .</span>
<span class="x">      .</span>
<span class="x">}</span>
<span class="x">else</span>
<span class="x">{</span>
<span class="x">    //Error</span>
<span class="x">    $errorNumber = $zarinPay-&gt;getStatusCode();</span>
<span class="x">}</span>
</code></pre></div>
<p>توسط دو قدم گفته شده در بالا میتوانید کل روند پرداخت درگاه زرین پال را انجام دهید.</p>


                    </div>
                
            </div>

            

            <div class=row-fluid>
                <div id=footer class=span12>
                    مستندات برای <a href="http://github.com/mohsen-shafiee/ipay">پکیج IPay</a>

<div class="social text-center">
    <a href="http://github.com/mohsen-shafiee/ipay">Github</a> |
    <a href="http://packagist.org/packages/mohsen/ipay">Packagist</a>
</div>

                </div>
            </div>
        </div>

        <script>
            function orderNav() {
                var list,
                    section,
                    header,
                    sections = [],
                    lists = {},
                    headers = {};

                var navUl = document.querySelectorAll('#navigation ul')[0],
                    navLis = document.querySelectorAll('#navigation ul li');

                if (!navUl) return;

                for (var i = 0; i < navLis.length; i++) {
                    var order, li = navLis[i];

                    if (li.classList.contains('nav-header')) {
                        section = li.textContent || li.innerText;
                        sections.push(section);
                        headers[section] = li;
                        continue;
                    }

                    if (!lists[section]) {
                        lists[section] = [];
                    }

                    order = parseFloat(li.getAttribute('data-order'))
                    lists[section].push([order, li]);
                }

                for (var i = 0; i < sections.length; i++) {
                    section = sections[i];
                    list = lists[section].sort(function(a, b) {
                        return a[0] - b[0];
                    });

                    if (header = headers[section]) {
                        navUl.appendChild(header);
                    }
                    for (var j = 0; j < list.length; j++) {
                        navUl.appendChild(list[j][1]);
                    }
                }
            }

            if (document.querySelectorAll) orderNav();
        </script>
        
    </body>
</html>
